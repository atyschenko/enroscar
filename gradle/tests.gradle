apply plugin: 'android-test'

android.libraryVariants.all { variant ->
  if (variant.buildType.name.equalsIgnoreCase('release')) { return }

  def task = tasks["test${variant.name.capitalize()}"]
  task.configure {
    scanForTestClasses = false

    def selection = null
    try {
      selection = project.testSelection
    } catch (def e) {
      // ignore
    }
    if (!selection) {
      selection = "**/*Test.class"
    }

    def debug = null
    try {
      debug = project.testDebug
    } catch (def e) {
      // ignore
    }
    if (debug == "yes") {
      jvmArgs '-Xdebug', '-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005'
    }

    include selection
    exclude "**/Abstract*.class"
  }

  // XXX: workaround to support 0.10 plugin
  def compileTask = tasks["compileTest${variant.name.capitalize()}Java"]
  compileTask.actions.remove(0)
  compileTask.doFirst {
    compileTask.options.bootClasspath = android.bootClasspath.join(File.pathSeparator)
  }
  task.actions.remove(0)
  task.doFirst {
    task.classpath += project.files(android.bootClasspath)
  }
}
